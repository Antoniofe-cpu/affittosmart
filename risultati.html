<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Risultati della tua Ricerca - Affitto Smart</title>
    <!-- Stessi stili -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --colore-primario: #0D47A1; --colore-accento: #FFB300; --colore-testo: #212121; --colore-testo-chiaro: #5f6368; --colore-sfondo-chiaro: #f5f7fa; }
        body { font-family: 'Poppins', sans-serif; margin: 0; background-color: var(--colore-sfondo-chiaro); }
        .container { max-width: 900px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; padding: 40px 0; }
        .header h1 { font-size: 2.8em; }
        .back-link { display: inline-block; margin-top: 20px; font-weight: 600; color: var(--colore-primario); text-decoration: none; }
        .property-card {
            background: white; border-radius: 12px; overflow: hidden;
            box-shadow: 0 8px 30px rgba(0,0,0,0.08); margin-bottom: 30px;
            display: flex; flex-wrap: wrap;
        }
        .property-card-img { flex: 1; min-width: 300px; max-height: 250px; }
        .property-card-img img { width: 100%; height: 100%; object-fit: cover; }
        .property-card-info { flex: 2; padding: 25px; }
        .property-card-info .price { font-size: 1.8em; font-weight: 800; color: var(--colore-primario); }
        .property-card-info .type-zone { font-weight: 600; color: var(--colore-testo-chiaro); }
        .property-card-info h3 { margin: 10px 0; font-size: 1.5em; }
        .property-card-info .address { margin-bottom: 15px; }
        .property-card .cta-button {
            display: inline-block; padding: 12px 25px; font-size: 0.9em; text-decoration: none;
            border-radius: 50px; background-image: linear-gradient(45deg, var(--colore-accento), #FF8F00);
            color: var(--colore-testo); font-weight: 700; transition: all 0.3s ease;
        }
        .message { text-align: center; padding: 40px; font-size: 1.2em; color: var(--colore-testo-chiaro); }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>Ecco le proposte per te</h1>
        </header>

        <div id="results-container">
            <p class="message">Caricamento degli immobili in corso...</p>
        </div>
        
        <div style="text-align: center;">
            <a href="cerca.html" class="back-link">Modifica la tua ricerca</a>
        </div>
    </div>

    <script>
    // --- CONFIGURAZIONE ---
    // Assicurati che questo link sia quello corretto da "File > Condividi > Pubblica sul web" (formato CSV)
    const GOOGLE_SHEET_URL = 'INCOLLA_QUI_IL_TUO_LINK_CSV_PUBBLICATO';

    // --- FUNZIONI ---

    // Funzione per convertire il testo CSV in un array di oggetti JavaScript
    function csvToObjects(csv) {
        // Separa il testo in righe, ignorando le righe vuote alla fine
        const lines = csv.trim().split('\n');
        if (lines.length < 2) return []; // Se non c'è almeno un'intestazione e una riga di dati, esci

        const headers = lines[0].split(',').map(h => h.trim());
        const objects = [];
        for (let i = 1; i < lines.length; i++) {
            if (lines[i]) {
                const values = lines[i].split(',');
                const obj = {};
                for (let j = 0; j < headers.length; j++) {
                    // Pulisce ogni valore da eventuali doppi apici che Google Sheets aggiunge
                    obj[headers[j]] = values[j] ? values[j].replace(/"/g, '').trim() : '';
                }
                objects.push(obj);
            }
        }
        return objects;
    }

    // Funzione per mostrare le card delle proprietà nel contenitore
    function displayResults(properties) {
        const resultsContainer = document.getElementById('results-container');
        resultsContainer.innerHTML = ''; // Pulisce i risultati precedenti

        if (properties.length === 0) {
            resultsContainer.innerHTML = '<p class="message">Nessun immobile corrisponde alla tua ricerca. Prova a modificare i filtri!</p>';
            return;
        }

        properties.forEach(p => {
            // Controlla che i dati essenziali non siano vuoti prima di creare la card
            if (!p.Titolo || !p.Prezzo || !p.FotoURL || !p.CalendlyURL) return;

            const card = `
                <div class="property-card">
                    <div class="property-card-img">
                        <img src="${p.FotoURL}" alt="${p.Titolo}">
                    </div>
                    <div class="property-card-info">
                        <div class="type-zone">${p.Tipo || ''} - ${p.Zona || ''}</div>
                        <h3>${p.Titolo}</h3>
                        <div class="price">${p.Prezzo} €/mese</div>
                        <p>${p.Descrizione || 'Nessuna descrizione disponibile.'}</p>
                        <a href="${p.CalendlyURL}" class="cta-button" target="_blank">Prenota Open Day</a>
                    </div>
                </div>
            `;
            resultsContainer.innerHTML += card;
        });
    }

    // Funzione principale che carica i dati e li filtra
    async function loadAndFilterProperties() {
        console.log("1. Funzione loadAndFilterProperties avviata."); // <-- Log di controllo
        const resultsContainer = document.getElementById('results-container');
        try {
            // Leggi i parametri dall'URL
            const params = new URLSearchParams(window.location.search);
            const tipo = params.get('tipo') || '';
            const zona = params.get('zona') || '';
            const prezzo = parseInt(params.get('prezzo'));
            const prezzoMax = isNaN(prezzo) ? Infinity : prezzo;
            console.log(`2. Filtri letti dall'URL: tipo=${tipo}, zona=${zona}, prezzoMax=${prezzoMax}`); // <-- Log di controllo

            // Carica i dati dal Google Sheet
            const response = await fetch(GOOGLE_SHEET_URL);
            if (!response.ok) {
                throw new Error(`Errore di rete: ${response.statusText}`);
            }
            const csvData = await response.text();
            console.log("3. Dati CSV caricati con successo."); // <-- Log di controllo
            
            const properties = csvToObjects(csvData);
            if (properties.length === 0) {
                console.warn("4. Attenzione: nessun dato convertito dal CSV. Controlla il formato del file.");
            } else {
                console.log(`4. Convertite ${properties.length} proprietà.`);
            }

            // Filtra le proprietà
            const filteredProperties = properties.filter(p => {
                const prezzoImmobile = parseInt(p.Prezzo);
                if (isNaN(prezzoImmobile)) return false;

                return p.Stato === 'Disponibile' &&
                       (tipo === '' || p.Tipo === tipo) &&
                       (zona === '' || p.Zona === zona) &&
                       (prezzoImmobile <= prezzoMax);
            });
            console.log(`5. Trovate ${filteredProperties.length} proprietà dopo il filtro.`); // <-- Log di controllo

            // Mostra i risultati
            displayResults(filteredProperties);
            console.log("6. Risultati mostrati sulla pagina."); // <-- Log di controllo

        } catch (error) {
            console.error('ERRORE CRITICO:', error);
            resultsContainer.innerHTML = `<p class="message">Si è verificato un errore. Assicurati che l'URL del database sia corretto e pubblicato come CSV.</p>`;
        }
    }

    // --- INNESCO DELLO SCRIPT ---
    // Usiamo DOMContentLoaded, che è più moderno e veloce di window.onload
    document.addEventListener('DOMContentLoaded', loadAndFilterProperties);

</script>
</body>
</html>
