<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Le Tue Opportunità Esclusive - Affitto Smart</title>
    
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="shortcut icon" href="favicon.ico">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { 
            --colore-primario: #0D47A1; 
            --colore-secondario: #1565C0;
            --colore-accento: #FFA000; 
            --colore-testo: #212121; 
            --colore-testo-chiaro: #5f6368; 
            --colore-sfondo-pagina: #f4f6f9; 
            --colore-successo: #2E7D32; 
            --colore-bianco: #ffffff;
        }
        body { 
            font-family: 'Poppins', sans-serif; 
            margin: 0; 
            background-color: var(--colore-sfondo-pagina);
            color: var(--colore-testo);
        }
        
        /* HEADER DI NAVIGAZIONE (BIANCO) */
        .main-header {
            display: flex;
            justify-content: center; /* Centra il logo */
            align-items: center;
            padding: 20px 40px;
            background-color: var(--colore-bianco);
            border-bottom: 1px solid #eee;
            position: relative; 
        }
        .main-header .logo {
            font-size: 2.2em;
            font-weight: 800;
            color: var(--colore-primario);
            text-decoration: none;
        }
        .main-header .logo span { 
            font-weight: 400; 
            color: var(--colore-secondario);
        }
        .header-actions {
            position: absolute;
            right: 40px;
            top: 50%;
            transform: translateY(-50%);
        }
        .login-link {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            color: var(--colore-primario);
            background-color: #e3f2fd;
            padding: 10px 20px;
            border-radius: 50px;
            text-decoration: none;
            border: 1px solid transparent;
            transition: all 0.3s ease;
        }
        .login-link:hover {
            background-color: var(--colore-bianco);
            border-color: var(--colore-primario);
            transform: translateY(-2px);
        }
        .login-link .fa-solid {
            font-size: 1.2em;
        }
        
        /* HEADER DI CONTESTO (BLU) */
        /* Regola corretta e unificata */
.page-header { 
    text-align: center; 
    padding: 60px 20px;
    background-color: var(--colore-primario); 
    color: var(--colore-bianco);
    box-shadow: 0 4px 12px rgba(13, 71, 161, 0.2);
    border-radius: 0 0 24px 24px; /* Angoli arrotondati */
    margin-bottom: 40px;         /* Spazio sotto */
}
        .page-header h1 { 
            font-size: 3em; 
            color: var(--colore-bianco); 
            text-shadow: 0 2px 4px rgba(0,0,0,0.2); 
            margin: 0; 
        }
        .page-header p { 
            font-size: 1.2em; 
            color: rgba(255,255,255,0.85); 
            margin-top: 10px; 
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
        }
        /* NUOVA REGOLA (CORRETTA) */


        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        .back-link-container { text-align: center; padding: 40px 0; }
        .back-link { font-weight: 600; color: var(--colore-primario); text-decoration: none; font-size: 1.1em; transition: color 0.3s; }
        .back-link:hover { color: var(--colore-accento); }
        
        #results-container { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .property-card { background: white; border-radius: 16px; box-shadow: 0 8px 30px rgba(0,0,0,0.08); display: flex; flex-direction: column; transition: transform 0.3s ease, box-shadow 0.3s ease; overflow: hidden; }
        .property-card:hover { transform: translateY(-5px); box-shadow: 0 12px 40px rgba(0,0,0,0.12); }
        .property-card-img { width: 100%; height: 220px; background-color: #eee; position: relative; }
        .property-card-img img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.4s ease; }
        .property-card:hover .property-card-img img { transform: scale(1.05); }
        .property-card-info { padding: 25px; display: flex; flex-direction: column; flex-grow: 1; }
        .property-card-info .type-zone { font-weight: 600; color: var(--colore-testo-chiaro); text-transform: capitalize; }
        .property-card-info h3 { margin: 5px 0 10px 0; font-size: 1.4em; }
        .property-card-info .price { font-size: 1.8em; font-weight: 800; color: var(--colore-primario); margin-bottom: 15px; }
        .property-card-info p { flex-grow: 1; font-size: 0.95em; margin-top: 0; color: #444; }
        /* NUOVE REGOLE CORRETTE */
.info-item {
    display: flex;
    align-items: center;
    font-weight: 700;
    margin-bottom: 10px; /* Spazio tra le righe di info */
}
.info-item i {
    margin-right: 10px;
    width: 20px;
    text-align: center;
}

/* Stile per la data dell'Open Day */
.info-item.open-day {
    color: var(--colore-primario); /* Blu primario */
}

/* Stile per la data di Disponibilità */
.info-item.availability {
    color: var(--colore-secondario); /* Blu secondario, per distinguerla */
}
        .booking-action { margin-top: auto; display: flex; justify-content: center; }
        .property-card .cta-button { display: flex; justify-content: center; align-items: center; gap: 10px; width: 100%; max-width: 320px; padding: 14px; font-size: 1em; text-decoration: none; border-radius: 8px; background-image: linear-gradient(45deg, var(--colore-accento), #FF8F00); color: var(--colore-testo); font-weight: 700; cursor: pointer; border: none; transition: all 0.2s; }
        .property-card .cta-button:hover { transform: scale(1.02); box-shadow: 0 4px 15px rgba(255, 160, 0, 0.4); }
        .property-card .cta-button.disabled { background-image: none; background-color: #ccc; cursor: not-allowed; box-shadow: none; transform: none; }
        .property-card .cta-button.booked { background-image: none; background-color: var(--colore-successo); color: white; }
        .property-card .cta-button.booked:hover { background-color: #1e8223; }
        .message { grid-column: 1 / -1; text-align: center; padding: 40px; font-size: 1.2em; color: var(--colore-testo-chiaro); }
        
        @media (max-width: 900px) { #results-container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <header class="main-header">
        <a href="index.html" class="logo">Affitto <span>Smart</span></a>
        <div class="header-actions">
            <a href="#" id="dashboard-link" class="login-link" style="display: none;">
                <i class="fa-solid fa-user-circle"></i> 
                
            </a>
        </div>
    </header>

    <header class="page-header">
        <div class="container">
            <h1>Le Tue Opportunità Esclusive</h1>
            <p>Ecco gli immobili 100% compatibili con il tuo profilo e le tue preferenze.</p>
        </div>
    </header>
    
    <div class="container">
        <div id="results-container">
            <p class="message"><i class="fa-solid fa-spinner fa-spin"></i> Sto analizzando la compatibilità tra te e le nostre proposte...</p>
        </div>
        
        <div class="back-link-container">
           <a href="index.html" class="back-link" id="back-link">Modifica la tua Ricerca</a>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
        const PROPERTIES_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRkbpjTqQmyIW-qPDT-iLpE6duimrufjvzM3AXd_ng8D2rXW0tTWz3KMmZ1oE8nUCDx0CkUtePZZr_N/pub?gid=0&single=true&output=csv';
        const REQUIREMENTS_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRkbpjTqQmyIW-qPDT-iLpE6duimrufjvzM3AXd_ng8D2rXW0tTWz3KMmZ1oE8nUCDx0CkUtePZZr_N/pub?gid=1003729734&single=true&output=csv';
        const CANDIDATES_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRkbpjTqQmyIW-qPDT-iLpE6duimrufjvzM3AXd_ng8D2rXW0tTWz3KMmZ1oE8nUCDx0CkUtePZZr_N/pub?gid=871257678&single=true&output=csv';

          let allCandidates = [];

            const csvToObjects = (csv) => {
                if (!csv) return [];
                const lines = csv.trim().split(/\r\n|\n/);
                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                return lines.slice(1).map(line => {
                    if (!line) return null;
                    const values = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                    return headers.reduce((obj, header, i) => {
                        obj[header] = values[i] ? values[i].replace(/"/g, '').trim() : '';
                        return obj;
                    }, {});
                }).filter(Boolean);
            };

            const normalizeString = (str) => {
                if (!str) return '';
                return str.toLowerCase().trim().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            };

            const displayResults = (properties, userProfile, bookedPropertyIds, userToken) => {
                const resultsContainer = document.getElementById('results-container');
                resultsContainer.innerHTML = '';
                if (properties.length === 0) {
                    resultsContainer.innerHTML = '<p class="message">Nessun immobile è risultato 100% compatibile.<br>Prova a modificare la ricerca!</p>';
                    return;
                }

                properties.forEach(p => {
                    if (!p.ID || !p.Titolo) return;
                    
                    const prenotati = allCandidates.filter(c => c.ID_Immobile_Prenotato === p.ID).length;
                    const postiTotali = parseInt(p.MaxPartecipanti) || 10;
                    const postiRimasti = postiTotali - prenotati;
                    
                    let buttonHtml;
                    const isAlreadyBooked = bookedPropertyIds.includes(p.ID);

                    if (isAlreadyBooked) {
                        buttonHtml = `<a href="dashboard.html?token=${userToken}" class="cta-button booked">Già Prenotato</a>`;
                    } else if (postiRimasti > 0) {
                        if (p.CalendlyLink) {
                            const registrationUrl = `registrazione.html?email=${encodeURIComponent(userProfile.user_email || '')}&propertyId=${p.ID}&calendlyLink=${encodeURIComponent(p.CalendlyLink || '')}`;
                            buttonHtml = `<a href="${registrationUrl}" class="cta-button available">Ottieni Ticket e Prenota <span class="spots-counter">(${postiRimasti}/${postiTotali})</span></a>`;
                        } else {
                            buttonHtml = `<button class="cta-button disabled" disabled>Prenotazioni non ancora aperte</button>`;
                        }
                    } else {
                        buttonHtml = `<button class="cta-button disabled" disabled>Posti Esauriti</button>`;
                    }

                    // Funzione helper per formattare la data
                    const formatDate = (dateString) => {
                        if (!dateString || dateString.length < 10) return 'Da Definire';
                        try {
                            const [year, month, day] = dateString.split('-');
                            return `${day}/${month}/${year}`;
                        } catch (e) {
                            return dateString; // Restituisci la stringa originale se il formato non è valido
                        }
                    };

                    const cardDiv = document.createElement('div');
                    cardDiv.className = 'property-card';
                    cardDiv.innerHTML = `
                        <div class="property-card-img"><img src="${p.FotoURL || 'https://via.placeholder.com/400x220'}" alt="${p.Titolo}"></div>
                        <div class="property-card-info">
                            <div class="type-zone">${p.Tipo || ''} - ${p.Zona || ''}</div>
                            <h3>${p.Titolo}</h3>
                            <div class="price">${p.Prezzo || 'N.D.'} €/mese</div>
                             <p>${p.Descrizione || 'Nessuna descrizione.'}</p>
    
    <div class="info-item open-day">
        <i class="fa-solid fa-calendar-check"></i> 
        <div><strong>Open Day:</strong> ${formatDate(p.DataOpenDay)}</div>
    </div>
    <div class="info-item availability">
        <i class="fa-solid fa-key"></i> 
        <div><strong>Disponibile dal:</strong> ${formatDate(p.data_disponibile)}</div>
    </div>

    <div class="booking-action">${buttonHtml}</div>
                        </div>`;
                    resultsContainer.appendChild(cardDiv);
                });
            };

            const main = async () => {
                const params = new URLSearchParams(window.location.search);
                const userToken = params.get('token');
                
                const dashboardLink = document.getElementById('dashboard-link');
                if (userToken && dashboardLink) {
                    dashboardLink.href = `dashboard.html?token=${userToken}`;
                    dashboardLink.style.display = 'inline-flex';
                }

                const backLink = document.getElementById('back-link');
                if (backLink) {
                    backLink.href = userToken ? `index.html?token=${userToken}` : 'index.html';
                }

                try {
                    const [propsRes, reqsRes, candsRes] = await Promise.all([
                        fetch(PROPERTIES_URL), fetch(REQUIREMENTS_URL), fetch(CANDIDATES_URL)
                    ]);
                    const allProperties = csvToObjects(await propsRes.text());
                    const allRequirements = csvToObjects(await reqsRes.text());
                    allCandidates = csvToObjects(await candsRes.text());
                    
                    let bookedPropertyIds = [];
                    if (userToken) {
                        bookedPropertyIds = allCandidates.filter(c => c.Token === userToken).map(b => b.ID_Immobile_Prenotato);
                    }
                    
                    const userFilters = {
                        user_email: params.get('user_email'),
                        tipo: normalizeString(params.get('tipo')),
                        zona: normalizeString(params.get('zona')),
                        prezzoMax: parseInt(params.get('prezzo')) || Infinity,
                        data_disponibile: params.get('data_disponibile'),
                        periodo_affitto: normalizeString(params.get('periodo_affitto')),
                        situazione_lavorativa: normalizeString(params.get('situazione_lavorativa')),
                        reddito: parseInt(params.get('reddito_utente')) || 0,
                        sesso: normalizeString(params.get('sesso_utente')),
                        fumatore: normalizeString(params.get('fumatore')),
                        animali: normalizeString(params.get('animali')),
                        tipo_ricerca: normalizeString(params.get('tipo_ricerca'))
                    };

                const finalProperties = allProperties.filter(property => {
                    const propertyID = (property.ID || '').trim();
                    if (!propertyID || (property.Stato || '').toLowerCase().trim() !== 'disponibile') return false;
                    if (userFilters.tipo && normalizeString(property.Tipo) !== userFilters.tipo) return false;
                    if (userFilters.zona && normalizeString(property.Zona) !== userFilters.zona) return false;
                    if ((parseInt(property.Prezzo) || 0) > userFilters.prezzoMax) return false;
                    if (userFilters.data_disponibile && property.data_disponibile) { try { if (new Date(property.data_disponibile) > new Date(userFilters.data_disponibile)) return false; } catch (e) {} }
                    if (userFilters.periodo_affitto && normalizeString(property.periodo_affitto) !== userFilters.periodo_affitto) return false;
                    
                    const propertyReqs = allRequirements.find(r => (r.ID_Immobile || '').trim() === propertyID);
                    if (propertyReqs) {
                        if (userFilters.situazione_lavorativa && normalizeString(propertyReqs.situazione_lavorativa) !== 'indifferente' && normalizeString(propertyReqs.situazione_lavorativa) !== userFilters.situazione_lavorativa) return false;
                        const redditoMinimoRichiesto = parseInt(propertyReqs.reddito_minimo) || 0;
                        if (redditoMinimoRichiesto > 0 && userFilters.reddito < redditoMinimoRichiesto) return false;
                    }
                    return true;
                });
                
                displayResults(finalProperties, userFilters, bookedPropertyIds, userToken);
                } catch (error) {
                    console.error("ERRORE CRITICO:", error);
                    document.getElementById('results-container').innerHTML = `<p class="message">Si è verificato un errore. Riprova.</p>`;
                }
            };
            
            main();
        });
    </script>
</body>
</html>
